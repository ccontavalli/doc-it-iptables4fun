<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="LinuxDoc-Tools 0.9.69">
 <TITLE>IPtables for Fun -- Implementare un firewall in linux: Preparare il proprio sistema: Patchare e prepararsi a ricompilare...</TITLE>
 <LINK HREF="iptables4fun-9.html" REL=next>
 <LINK HREF="iptables4fun-7.html" REL=previous>
 <LINK HREF="iptables4fun.html#toc4" REL=contents>
</HEAD>
<BODY>
<A HREF="iptables4fun-9.html">Avanti</A>
<A HREF="iptables4fun-7.html">Indietro</A>
<A HREF="iptables4fun.html#toc4">Indice</A>
<HR>
<H2>4.2 <A HREF="iptables4fun.html#toc4.2">Patchare e prepararsi a ricompilare...</A></H2>

<P>Prima di ricompilare, &egrave; bene fare una precisazione. Il ``netfilter'' code del
kernel di linux, ovvero la parte di kernel che si occupa di fare da firewall,
&egrave; realizzato e rilasciato da un gruppo indipendente da quello
che prettamente si occupa del kernel di linux. Capita quindi spesso che persino
l'ultimissima release del kernel di linux sia rimasta
indietro rispetto all'ultima versione del codice di filtraggio (il netfilter).</P>
<P>Considerando poi che molto velocemente vengono rilasciati bug fix e nuove funzioni
vengono introdotte, una delle cose pi&ugrave; importanti da fare &egrave; aggiornare iptables
ed il kernel all'ultimissima versione, stando attenti per&ograve; a mantenerli in
sincronia. Per fare questo, il gruppo di sviluppo del netfilter ha messo a disposizione
uno strumento estremamente potente quanto facile da usare: il patch-o-matic.</P>
<P>Col passare del tempo, per&ograve;, questo strumento si &egrave; evoluto e modificato. 
Per cui, a secondo della versione di iptables che vorrete installare, dovrete seguire
due percorsi diversi. In particolare, se i sorgenti di iptables che avete scaricato
sono della versione 1.2.6 o minore, seguite le istruzioni indicate nella sezione 
``iptables 1.2.6'', altrimenti seguite quelle indicate nella sezione ``iptables 1.2.7a''.</P>

<H3>iptables 1.2.6 - Usare il patch-o-matic</H3>

<P>Entrate quindi nella directory dei sorgenti di iptables, collegatevi ad internet ed iniziate dando
un comando come:
<BLOCKQUOTE><CODE>
<PRE>
        # make pending-patches KERNEL-DIR=path_assoluto/delvostrokernel
</PRE>
</CODE></BLOCKQUOTE>

A questo punto, un'interfaccia a men&ugrave; vi guider&agrave; nell'aggiornamento del
vostro kernel. Attenzione che &egrave; meglio (a volte indispensabile) specificare un path assoluto per 
il proprio kernel. In pratica, usate qualcosa come /usr/src/linux anzich&eacute;
../linux o &nbsp;/src/linux. </P>
<P>Questo comando applicher&agrave; sia al kernel che ai vostri sorgenti di 
iptables tutte quelle patch che sarebbero dovute essere applicate prima
del rilascio del kernel ufficiale, ma che per motivi vari non hanno fatto
in tempo ad essere inserite (normalmente,
si tratta di correzione di bug o piccole modifiche realizzate dopo
il rilascio del kernel). Se state utilizzando i sorgenti del kernel della
vostra distribuzione preferita, non dovreste preoccuparvi pi&ugrave;
di tanto. Il patch-o-matic &egrave; infatti in grado di capire da solo 
quali aggiornamenti sono gi&agrave; stati applicati e di evitare la maggior
parte dei problemi.</P>
<P>Dopo questo primo passo, nel caso vi sentiste particolarmente coraggiosi 
ed inebriati dal successo appena ottenuto, potreste voler proseguire
con un 
<BLOCKQUOTE><CODE>
<PRE>
        # make most-of-pom KERNEL-DIR=path_assoluto/delvostrokernel
</PRE>
</CODE></BLOCKQUOTE>

Come prima, apparir&agrave; un'interfaccia a men&ugrave; che vi guider&agrave;
nell'aggiornamento dei vari sorgenti. A differenza di prima, per&ograve;,
questo comando tenter&agrave; di installare anche le estensioni che ancora non
sono parte del kernel o classificate sperimentali. Tra queste, ce ne
sono parecchie che la maggior parte delle distribuzioni includono
perch&eacute; ormai abbastanza testate, o che comunque saranno incluse nelle 
prossime versioni del kernel... c'&egrave; sempre un sacco di materiale interessante
che spesso vale la pena di installare. Alcune funzioni poi, vi
torneranno utili dopo, magari se vorrete dilettarvi con firewall
trasparenti o imponendo limiti per orari o 
sul numero di connessioni parallele o ancora buttando via casualmente
i pacchetti delle persone che pi&ugrave; vi stanno antipatiche.</P>
<P>Non preoccupatevi poi se avete paura di applicare patch incompatibili
o troppo instabili: most-of-pom &egrave; fatto in modo da evitarvi 
simili errori. In pratica, cercher&agrave; di evitere che vi facciate male da soli.</P>
<P>Se invece vi sentite ancor pi&ugrave; coraggiosi e tutte le ultime feature
del netfilter vi piacciono veramente tanto, potete provare un
<BLOCKQUOTE><CODE>
<PRE>
        # make patch-o-matic KERNEL-DIR=path_assoluto/delvostrokernel
</PRE>
</CODE></BLOCKQUOTE>

che invece vi metter&agrave; a disposizione tutte le nuove feature, dalle
pi&ugrave; inoffensive a quelle pi&ugrave; pericolose, dalle pi&ugrave; testate a quelle
pi&ugrave; instabili, comprese quelle incompatibili tra di loro. In questo
caso, star&agrave; alla vostra abilit&agrave; ottenere qualcosa di funzionante.</P>

<H3>iptables 1.2.7 - Usare il patch-o-matic</H3>

<P>Ok, in questo caso, dovrete avere a disposizione sia i sorgenti di iptables, sia
i sorgenti del patch-o-matic. Dall'1.2.7 in poi, infatti, i sorgenti del patch-o-matic
vengono distribuiti indipendentemente dal codice di iptables. </P>
<P>Ipotizzando di aver decompresso tutto in /usr/src, dovrete iniziare
entrando nella directory del patch o matic, ovvero
<BLOCKQUOTE><CODE>
<PRE>
  # cd patch-o-matic-xxxxxxxx
</PRE>
</CODE></BLOCKQUOTE>

dove le 8 x non sono altro che la data di rilascio del patch-o-matic.
Da qui, vi dovrebbe bastare eseguire:
<BLOCKQUOTE><CODE>
<PRE>
  # ./runme pending KERNEL_DIR=/path/assoluto/del/kernel
</PRE>
</CODE></BLOCKQUOTE>

dove ``/path/assoluto/del/kernel'' &egrave; il path dove avete decompresso
il kernel, per esempio ``/usr/src/kernel-source-2.4.19''. In questo caso,
il ``pending'' sta ad indicare che volete installare tutte quelle patch
che sarebbero dovute essere state inserite  prima del rilascio del kernel
ma che per un motivo o per l'altro non sono state applicate.</P>
<P>Come per iptlables 1.2.6, i coraggiosi potrebbero voler riprovare ad
eseguire il comando di prima sostituendo a ``pending'' un ``base'' e poi un ``extra''.</P>
<P>Il ``base'' vi proporr&agrave; l'installazione di quelle patch addizionali che 
dovrebbero lavorare bene insieme e che comunque si sono dimostrate abbastanza stabili. 
Al contrario, un ``extra'' vi proporr&agrave; l'installazione
di <I>tutte</I> le patch disponibili, anche di quelle che potrebbero causare
problemi. Fra queste, alcune possono essere particolarmente utili, come il
supporto per l'h323 o per protocolli o filtri un po' esotici, come lo ``string''
o l'``iplimit''. In ogni caso, vi verr&agrave; presentata una simpatica e
semplice da utilizzare interfaccia a men&ugrave;.</P>


<H3>iptables 1.2.7 - in Debian</H3>

<P>Il pacchetto Debian per iptables 1.2.7 &egrave; strutturato in
modo che nella directory upstream vi siano alcuni file di documentazione ed i
sorgenti originali di iptables (in formato tar.bz2), mentre nella directory debian vi
siano i file necessari per ricompilare iptables.</P>
<P>Automaticamente quindi, il processo di compilazione (avviato utilizzando
il solito ``debuild'' o ``dpkg-buildpackage'')si occuper&agrave; di prendere
i sorgenti del kernel indicati nel file debian/control (campo
Depends, che dovranno gi&agrave; essere installati sul sistema), decomprimerli 
e patcharli con il patch-o-matic contenuto nella directory ``upstream'' ed 
utilizzando tutte le patch elencate nel file ``patch-o-matic.accepted.list''.</P>
<P>Alla fine del processo di compilazione, dovreste quindi trovarvi con i nuovi pacchetti
.deb per iptables ed un nuovo .tar.bz2 contenente i sorgenti del kernel patchati in automatico
da ``debuild''. A questo punto, dovrete rimuovere i sorgenti precedentemente decompressi in 
/usr/src ed utilizzare quelli appena generati dal processo di compilazione di 
iptables, proseguendo poi con il processo di compilazione standard del kernel.</P>
<P>Se invece volete personalizzare il processo di compilazione, dovrete:
<UL>
<LI>Per utilizzare un kernel diverso da quello per cui &egrave; stato
creato il pacchettino, vi consiglio di dare un comando, dalla directory
dove avete decompresso i sorgenti (per esempio, /usr/src/iptables-1.2.7a)
simile a:
<BLOCKQUOTE><CODE>
<PRE>
  # perl -pi -e s/kernel-source-2.4.19/kernel-source-2.4.20/g `find ./ -type -f`
</PRE>
</CODE></BLOCKQUOTE>

per utilizzare i sorgenti del 2.4.20 anzich&eacute; quelli del 2.4.19. 
Questo comando, semplicemente, sostituisce in ogni file della directory
la stringa ``kernel-source-2.4.19'' con la stringa ``kernel-source-2.4.20''.
Abbiate fiducia, la stringa ``kernel-source-2.4.19'' appare solo dove
viene utilizzata per decomprimere i sorgenti del kernel.</LI>
<LI>Per utilizzare una versione diversa del patch-o-matic, scaricate tale
versione in formato .tar.bz2 nella directory upstream, dopodich&egrave; date:
<BLOCKQUOTE><CODE>
<PRE>
  # perl -pi -e s/patch-o-matic-20020825/patch-o-matic-20030220/g `find ./ -type -f`
</PRE>
</CODE></BLOCKQUOTE>

per utilizzare la versione 20030220 al posto della versione 20020825.</LI>
<LI>Infine, per elencare delle patch aggiuntive da applicare, potreste voler
aggiungere delle nuove righe nel file ``patch-o-matic.accepted.list'' nello
stesso formato in cui le altre righe sono indicate (in poche parole, non
cambiate la directory, fate un copia &amp; incolla cambiando solo il nome della
patch).</LI>
</UL>

Questa probabilmente non &egrave; la procedura pi&ugrave; facile o pi&ugrave; semplice
da utilizzare, ma il pacchettino debian non &egrave; stato progettato per essere 
facilmente  modificato dagli utenti.</P>
<P>In questi casi, la soluzione migliore potrebbe essere quella di aspettare la nuova 
versione del pacchetto.</P>
<P>Comunqe, per compilare i sorgenti, dovrete ancora una volta utilizzare ``debuild'' o
``dpkg-buildpackage'', ricordandovi di utilizzare la nuova versione del kernel 
che verr&agrave; generata sotto forma di .tar.bz2 dal processo di compilazione di
iptables.</P>

<H3>Altre patch</H3>

<P>Ok, adesso avete l'ultimissima versione del netfilter e di iptables. Se 
state per&ograve; configurando un firewall ad uso provider, reti di grosse/medie
dimensioni o se avete intenzione di installarlo in posti particolarmente
selvaggi con un minimo di banda a disposizione (non vale la pena se avete
solo una ADSL o poco di pi&ugrave;...), potreste voler essere in grado di
effettuare dello shaping. Alcune tra le patch pi&ugrave; famose per lo shaping 
sono:
<UL>
<LI>L'HTB, ovvero Hicerical Token Bucket filter, un class based queue
molto pi&ugrave; facile da usare e pi&ugrave; preciso (nonch&eacute; altrettanto potente)
dell'equivalente CBQ (tra l'altro, molto ben documentato). E' incluso
nei kernel dal 2.4.20 in su.</LI>
<LI>Il wrr, o Weighted Round Robin, utile soprattutto se avete tanti utenti
dove alcuni si divertono con flashget o equivalenti a saturare completamente
la banda bloccando a tutti gli altri persino la navigazione. 
Disponibile su 
<A HREF="http://wipl-wrr.sourceforge.net">http://wipl-wrr.sourceforge.net</A>, distribuisce equamente la banda
in base alle persone collegate.</LI>
<LI>Se invece non avete una connessione dedicata ma tante ADSL, potreste volere
patchare il kernel in modo che possa essere in grado di fare il bilanciamento
non solo per pacchetto (non funzionerebbe per via del NAT, probabilmente) ma 
per connessione. Non ricordo per&ograve; l'URL della patch.</LI>
</UL>

In questo documento, comunque, non tratteremo l'uso di queste patch, bens&igrave; solo
la loro installazione.</P>
<P>Comunque sia, per queste e tutte le altre patch che vorrete applicare sul codice
di filtraggio o di shaping, la procedura generica &egrave; questa:
<OL>
<LI>Se la patch riguarda nuove capacit&agrave; di filtraggio, probabilmente
riguarda iptables, mentre se introduce nuovi metodi per gestire il traffico
dei pacchetti o le tabelle di routing, probabilmente riguarda iproute.</LI>
<LI>Decomprimete la patch da qualche parte sul vostro disco. Dovrebbero venir
fuori due file .diff: uno per iproute o iptables, l'altro per il vostro kernel.</LI>
<LI>Entrate nella directory del vostro kernel (per esempio, &nbsp;/src/linux/) e
date un 
<BLOCKQUOTE><CODE>
<PRE>
        # patch -p1 &lt; path/file_del_kernel_patch.diff
</PRE>
</CODE></BLOCKQUOTE>
</LI>
<LI>Entrate nella directory di iptables o di iproute (per quanto riguarda il 
netfilter ed il codice di shaping, il 99% delle volte ad ogni patch
del kernel corrisponde una di iptables o iproute) e date:
<BLOCKQUOTE><CODE>
<PRE>
        # patch -p1 &lt; path/file_di_iptables_o_iproute_patch.diff
</PRE>
</CODE></BLOCKQUOTE>
</LI>
</OL>
</P>

<HR>
<A HREF="iptables4fun-9.html">Avanti</A>
<A HREF="iptables4fun-7.html">Indietro</A>
<A HREF="iptables4fun.html#toc4">Indice</A>
</BODY>
</HTML>
