<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="LinuxDoc-Tools 0.9.69">
 <TITLE>IPtables for Fun -- Implementare un firewall in linux: Mettere tutto insieme</TITLE>
 <LINK HREF="iptables4fun-32.html" REL=next>
 <LINK HREF="iptables4fun-30.html" REL=previous>
 <LINK HREF="iptables4fun.html#toc10" REL=contents>
</HEAD>
<BODY>
<A HREF="iptables4fun-32.html">Avanti</A>
<A HREF="iptables4fun-30.html">Indietro</A>
<A HREF="iptables4fun.html#toc10">Indice</A>
<HR>
<H2><A NAME="s10">10.</A> <A HREF="iptables4fun.html#toc10">Mettere tutto insieme</A></H2>

<P>Ok, abbiamo visto come configurare dei filtri ed il NAT. Mancano per&ograve; ancora
un paio di cosettine di cui sarebbe il caso di parlare.</P>
<P>Prima di tutto, soprattutto quando staremo correggendo gli errori nelle nostre regole,
caricheremo e ricaricheremo il nostro script finch&eacute; non vedremo queste regole
funzionare (molte volte). Il fatto &egrave; che creando delle catene, non chiediamo
di svuotarle nel caso queste esistano gi&agrave;, per cui continueremmo ad aggiungere
regole su regole, non semplificandoci affatto la correzione degli errori.</P>
<P>Potreste quindi voler aggiungere qualcosa come:
<BLOCKQUOTE><CODE>
<PRE>
for table in nat mangle filter
do
   iptables -t $table -F
   iptables -t $table -X
done
</PRE>
</CODE></BLOCKQUOTE>

all'inizio del vostro script... che elimina tutte le catene e tutte le regole inserite
in ogni tabella. Allo stesso modo, potreste voler aggiungere qualcosa come 
<BLOCKQUOTE><CODE>
<PRE>
(
for interface in eth0 eth1 eth2 eth3
do
  ip route flush dev $interface
  ip addr flush dev $interface
  ip link set down dev $interface
done;
) &amp;>/dev/null
</PRE>
</CODE></BLOCKQUOTE>

Sempre all'inizio del nostro script, per riportare tutte le interfacce e le impostazioni
ad uno stato conosciuto, in modo che non si vadano in continuazione ad aggiungere route
o indirizzi, che, aggiunti per ultimi, verrebbero ignorati in favore di vecchie configurazioni
che si combinerebbero e mischierebbero in maniera poco prevedibile. Comunque, ``ip route flush dev ethx''
elimina tutti i route relativi ad ethx, ``ip addr flush'' elimina tutti gli indirizzi dell'interfaccia
ed infine ``ip link set down'' spegnere la scheda di rete.</P>
<P>Infine, dobbiamo attivare le nostre interfacce di rete, configurare la tabella di routing ed abilitare
il ``forwarding'', dicendo al kernel di iniziare a trasmettere i pacchetti da una scheda di rete all'altra:
<BLOCKQUOTE><CODE>
<PRE>
86: ip link set up dev eth0
87: ip link set up dev eth1
88: ip link set up dev eth2

89: ip route add default via 123.45.68.254

90: echo 1 > /proc/sys/net/ipv4/ip_forward
</PRE>
</CODE></BLOCKQUOTE>

In questo caso, ip_forward non pu&ograve; essere aggiunto al file
sysctl.conf, in quanto vogliamo che il forwarding venga attivato
solo dopo che abbiamo impostato correttamente le regole di firewalling.</P>

<P>Non ci resta quindi che creare in /etc/rcS.d/ o rc2.d (a secondo della
distribuzione) un link al file appena completato, in modo che questo venga 
eseguito ad ogni reboot, con qualcosa come ``ln -s ../init.d/ifconffw ./S40ifconffw''
oppure ``update-rc.d ifconffw start 40 S'' in Debian. </P>


<HR>
<A HREF="iptables4fun-32.html">Avanti</A>
<A HREF="iptables4fun-30.html">Indietro</A>
<A HREF="iptables4fun.html#toc10">Indice</A>
</BODY>
</HTML>
